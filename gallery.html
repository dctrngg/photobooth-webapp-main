<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TekyFrame</title>
  <link rel="stylesheet" href="StyleSheets/gallery.css" />

  <!-- Tối ưu: Skeleton CSS -->
  <style>
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 1rem;
      height: 280px;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .load-more {
      margin: 2rem auto;
      padding: 0.8rem 2rem;
      font-size: 1.1rem;
      display: block;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 id="title">Gallery</h1>
    <div class="controls">
      <button class="btn btn-refresh" id="refreshBtn">Làm mới</button>
      <a href="#" class="btn btn-camera" id="cameraBtn">Chụp thêm</a>
      <a href="index.html" class="btn btn-home">Trang chủ</a>
    </div>
    <div class="status" id="status">Đang tải ảnh...</div>
  </div>

  <div class="gallery" id="gallery"></div>

  <div class="empty" id="empty" style="display: none;">
    <h2>Chưa có ảnh nào</h2>
    <p>Hãy chụp ảnh đầu tiên!</p>
    <a href="#" class="btn btn-camera" id="firstBtn" style="padding: 15px 40px; font-size: 1.1em;">Bắt đầu chụp</a>
  </div>

  <div class="modal" id="modal">
    <span class="close-modal" id="closeModal">×</span>
    <div class="modal-content">
      <img id="modalImg" src="" alt="Full size" loading="lazy" />
    </div>
  </div>

  <script>
    // ================= CẤU HÌNH =================
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycby3FqIIsC3cRT5CIXllLsHIlfWA4owQdvxGJRXbPAqlsvr1rI7eGKAFOOZCPvjxxQa0/exec',
      PROXY: 'https://api.allorigins.win/get?url=', // BỎ CORS
      LIMIT: 12,
      CACHE_KEY: 'gallery_cache',
      CACHE_TTL: 5 * 60 * 1000 // 5 phút
    };

    // ================= BIẾN TOÀN CỤC =================
    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('topic') || 'default';
    const topics = JSON.parse(localStorage.getItem('TOPICS_CONFIG') || '[]');
    const topic = topics.find(t => t.id === topicId);

    const gallery = document.getElementById('gallery');
    const status = document.getElementById('status');
    const empty = document.getElementById('empty');
    const refreshBtn = document.getElementById('refreshBtn');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');

    let photos = [];
    let displayed = 0;

    // ================= CẬP NHẬT UI =================
    if (topic) document.getElementById('title').textContent = ` ${topic.name}`;
    document.getElementById('cameraBtn').href = `topic.html?topic=${topicId}`;
    document.getElementById('firstBtn').href = `topic.html?topic=${topicId}`;

    const updateStatus = (msg, type = '') => {
      status.className = `status ${type}`;
      status.innerHTML = msg;
    };

    // ================= TẠO CARD ẢNH (THUMB + LAZY) =================
    const createCard = (photo, i) => {
      const card = document.createElement('div');
      card.className = 'photo-card';

      const thumb = photo.thumbUrl || photo.imageUrl.replace(/(\.jpg|\.png|\.jpeg)$/i, '-thumb$1');
      const full = photo.imageUrl;

      card.innerHTML = `
        <img src="${thumb}" 
             data-full="${full}" 
             alt="Photo ${i + 1}" 
             loading="lazy"
             onerror="this.src='${full}'; this.onerror=null;">
        <div class="photo-actions">
          <a href="${full}" download class="btn-download">Tải</a>
          <a href="${full}" target="_blank" class="btn-view">Xem</a>
        </div>
      `;

      const img = card.querySelector('img');
      img.style.cursor = 'pointer';
      img.addEventListener('click', () => {
        modalImg.src = full;
        modal.classList.add('active');
      });

      return card;
    };

    // ================= TẢI THÊM ẢNH =================
    const loadMore = () => {
      const start = displayed;
      const end = Math.min(displayed + CONFIG.LIMIT, photos.length);

      for (let i = start; i < end; i++) {
        gallery.appendChild(createCard(photos[i], i));
      }

      displayed = end;

      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if (loadMoreBtn) {
        loadMoreBtn.style.display = displayed < photos.length ? 'block' : 'none';
      }
    };

    // ================= HIỂN THỊ SKELETON =================
    const showSkeletons = (count = 6) => {
      gallery.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'photo-card skeleton';
        gallery.appendChild(skeleton);
      }
    };

    // ================= GỌI API QUA PROXY (BỎ CORS) =================
    const load = async (force = false) => {
      try {
        // 1. Kiểm tra cache
        if (!force) {
          const cached = localStorage.getItem(CONFIG.CACHE_KEY);
          if (cached) {
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp < CONFIG.CACHE_TTL && data.topicId === topicId) {
              photos = data.photos;
              renderPhotos();
              console.log('Từ cache');
              return;
            }
          }
        }

        // 2. Hiển thị skeleton
        showSkeletons();
        updateStatus('<span class="spinner"></span>Đang tải...', 'loading');

        // 3. Gọi API qua proxy
        const apiUrl = `${CONFIG.API_URL}?topic=${topicId}&t=${Date.now()}`;
        const proxyUrl = `${CONFIG.PROXY}${encodeURIComponent(apiUrl)}`;

        const res = await fetch(proxyUrl);
        if (!res.ok) throw new Error(`Hình ảnh đang được xử lý`);

        const proxyData = await res.json();
        const data = JSON.parse(proxyData.contents);

        if (!data.success) throw new Error('Hình ảnh đang được xử lý');

        photos = (data.photos || []).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        // 4. Lưu cache
        localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify({
          data: { topicId, photos },
          timestamp: Date.now()
        }));

        // 5. Render
        renderPhotos();

      } catch (err) {
        console.error('Lỗi:', err);
        updateStatus(`Lỗi: ${err.message}`, 'error');
        gallery.innerHTML = '';
      }
    };

    // ================= RENDER ẢNH =================
    const renderPhotos = () => {
      gallery.innerHTML = '';
      displayed = 0;

      if (photos.length === 0) {
        status.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      status.style.display = 'none';
      empty.style.display = 'none';

      loadMore(); // Hiển thị 12 ảnh đầu

      // Nút "Tải thêm"
      let loadMoreBtn = document.getElementById('loadMoreBtn');
      if (!loadMoreBtn && displayed < photos.length) {
        loadMoreBtn = document.createElement('button');
        loadMoreBtn.id = 'loadMoreBtn';
        loadMoreBtn.textContent = 'Tải thêm ảnh';
        loadMoreBtn.className = 'btn btn-refresh load-more';
        loadMoreBtn.onclick = loadMore;
        document.querySelector('.header').appendChild(loadMoreBtn);
      }
      if (loadMoreBtn) {
        loadMoreBtn.style.display = displayed < photos.length ? 'block' : 'none';
      }
    };

    // ================= SỰ KIỆN =================
    refreshBtn.addEventListener('click', () => load(true));
    closeModal.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') modal.classList.remove('active'); });

    // Tự động tải mỗi 10s (có cache)
    setInterval(() => load(false), 10000);

    // Khởi động
    load();
  </script>
</body>

</html>