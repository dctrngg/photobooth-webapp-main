<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Photobooth</title>
    <link rel="stylesheet" href="StyleSheets/gallery.css" />
</head>

<body>
    <div class="header">
        <h1 id="title">Gallery</h1>
        <div class="controls">
            <button class="btn btn-refresh" id="refreshBtn">L√†m m·ªõi</button>
            <a href="#" class="btn btn-camera" id="cameraBtn">Ch·ª•p th√™m</a>
            <a href="index.html" class="btn btn-home">Trang ch·ªß</a>
        </div>
        <div class="status" id="status">ƒêang t·∫£i ·∫£nh...</div>
    </div>
    <div class="gallery" id="gallery"></div>
    <div class="empty" id="empty" style="display: none;">
        <h2>Ch∆∞a c√≥ ·∫£nh n√†o</h2>
        <p>H√£y ch·ª•p ·∫£nh ƒë·∫ßu ti√™n!</p>
        <a href="#" class="btn btn-camera" id="firstBtn" style="padding: 15px 40px; font-size: 1.1em;">B·∫Øt ƒë·∫ßu ch·ª•p</a>
    </div>
    <div class="modal" id="modal">
        <span class="close-modal" id="closeModal">√ó</span>
        <div class="modal-content"><img id="modalImg" src="" alt="Full size"></div>
    </div>

    <script>
        const CONFIG = {
            SHEET_API_URL: 'https://script.google.com/macros/s/AKfycby3FqIIsC3cRT5CIXllLsHIlfWA4owQdvxGJRXbPAqlsvr1rI7eGKAFOOZCPvjxxQa0/exec'
        };

        const urlParams = new URLSearchParams(window.location.search);
        const topicId = urlParams.get('topic') || 'default';
        const topics = JSON.parse(localStorage.getItem('TOPICS_CONFIG') || '[]');
        const topic = topics.find(t => t.id === topicId);
        if (topic) document.getElementById('title').textContent = ` ${topic.name}`;
        document.getElementById('cameraBtn').href = `topic.html?topic=${topicId}`;
        document.getElementById('firstBtn').href = `topic.html?topic=${topicId}`;

        const gallery = document.getElementById('gallery');
        const status = document.getElementById('status');
        const empty = document.getElementById('empty');
        const refreshBtn = document.getElementById('refreshBtn');
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modalImg');
        const closeModal = document.getElementById('closeModal');

        const updateStatus = (msg, type = '') => { status.className = `status ${type}`; status.innerHTML = msg; };

       const createCard = (photo, i) => {
    const card = document.createElement('div');
    card.className = 'photo-card';

    // ∆Øu ti√™n thumb, n·∫øu l·ªói ‚Üí d√πng ·∫£nh g·ªëc
    const thumb = photo.thumbUrl || photo.imageUrl;

    card.innerHTML = `
        <img src="${thumb}" 
             data-full="${photo.imageUrl}" 
             alt="Photo ${i + 1}" 
             loading="lazy" 
             width="280" height="280"
             style="image-rendering: -webkit-optimize-contrast;">
        <div class="photo-actions">
            <a href="${photo.imageUrl}" download class="btn-download">T·∫£i</a>
            <a href="${photo.imageUrl}" target="_blank" class="btn-view">Xem</a>
        </div>
    `;

    const img = card.querySelector('img');
    img.addEventListener('click', () => {
        modalImg.src = photo.imageUrl;
        modal.classList.add('active');
    });

    // N·∫øu thumb m·ªù ‚Üí t·ª± ƒë·ªông d√πng ·∫£nh g·ªëc (v·∫´n nhanh v√¨ ƒë√£ cache)
    img.onerror = () => img.src = photo.imageUrl;

    return card;
};
        const load = async () => {
    try {
        updateStatus('<span class="spinner"></span>ƒêang t·∫£i...', 'loading');
        
        // LOG: URL g·ªçi API
        const url = `${CONFIG.SHEET_API_URL}?topic=${topicId}&t=${Date.now()}`;
        console.log('üîç G·ªçi API URL:', url);
        console.log('üîç Topic ID:', topicId);

        const res = await fetch(url);
        console.log('üîç Response status:', res.status);
        
        if (!res.ok) throw new Error(`HTTP ${res.status} - Ki·ªÉm tra deploy Apps Script`);

        const text = await res.text();
        console.log('üîç Raw JSON response:', text);

        const data = JSON.parse(text);
        console.log('üîç Parsed data:', data);
        console.log('üîç Photos array:', data.photos);

        if (!data.success) throw new Error(data.error || 'L·ªói server - Ki·ªÉm tra Executions log');

        const photos = data.photos || [];
        console.log('üîç S·ªë l∆∞·ª£ng ·∫£nh:', photos.length);
        
        gallery.innerHTML = '';

        if (photos.length === 0) {
            console.log('‚ö†Ô∏è Kh√¥ng c√≥ ·∫£nh - Ki·ªÉm tra topic trong Sheet');
            status.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        status.style.display = 'none';
        empty.style.display = 'none';

        photos.forEach((photo, i) => {
            console.log(`üîç ·∫¢nh ${i + 1}:`, photo);
            if (photo.imageUrl) {
                gallery.appendChild(createCard(photo, i));
            } else {
                console.log('‚ö†Ô∏è ·∫¢nh thi·∫øu imageUrl:', photo);
            }
        });

        console.log('‚úÖ ƒê√£ render', photos.length, '·∫£nh');

    } catch (err) {
        console.error('‚ùå L·ªñI CHI TI·∫æT:', err);
        updateStatus(`L·ªói: ${err.message} - Xem Console F12`, 'error');
    }
};

        refreshBtn.addEventListener('click', load);
        closeModal.addEventListener('click', () => modal.classList.remove('active'));
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') modal.classList.remove('active'); });
        setInterval(load, 10000);
        load();
    </script>
</body>

</html>