<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera - Photobooth</title>
    <link rel="stylesheet" href="StyleSheets/topic.css" />
</head>

<body>
    <div class="container">
        <h1 id="title">Photobooth</h1>
        <div class="camera-box">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" width="1176" height="1470"></canvas>
            <img id="frameOverlay" class="frame-overlay" alt="Frame" />
            <div class="countdown">3</div>
        </div>
        <div class="controls">
            <button id="captureBtn">Chụp ảnh</button>
            <button id="flipBtn">Xoay</button>
        </div>
        <div class="status" id="status">Sẵn sàng chụp ảnh</div>
        <div style="text-align: center;">
            <a href="memory.html" class="link">Quay lại</a>
            <a href="#" id="galleryLink" class="link">Xem ảnh</a>
        </div>
    </div>

<script>
    const CONFIG = {
        IMGBB_API_KEY: '4bd63cc0de6bbbbea2c19f34586e40f3',
        SHEET_API_URL: 'https://script.google.com/macros/s/AKfycby3FqIIsC3cRT5CIXllLsHIlfWA4owQdvxGJRXbPAqlsvr1rI7eGKAFOOZCPvjxxQa0/exec'
    };

    const W = 1176, H = 1470, HALF = H / 2;
    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('topic') || 'default';
    const topics = JSON.parse(localStorage.getItem('TOPICS_CONFIG') || '[]');
    const topic = topics.find(t => t.id === topicId);
    if (topic) document.getElementById('title').textContent = ` ${topic.name}`;
    document.getElementById('galleryLink').href = `gallery.html?topic=${topicId}`;

    // Tạo 2 video riêng
    const video1 = document.createElement('video');
    const video2 = document.createElement('video');
    video1.autoplay = video2.autoplay = true;
    video1.playsInline = video2.playsInline = true;
    video1.style.cssText = 'position:absolute; top:0; left:0; width:100%; height:50%; object-fit:cover; z-index:1; display:none;';
    video2.style.cssText = 'position:absolute; top:50%; left:0; width:100%; height:50%; object-fit:cover; z-index:1; display:none;';

    const cameraBox = document.querySelector('.camera-box');
    cameraBox.appendChild(video1);
    cameraBox.appendChild(video2);

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const captureBtn = document.getElementById('captureBtn');
    const flipBtn = document.getElementById('flipBtn');
    const countdown = document.querySelector('.countdown');
    const status = document.getElementById('status');
    const frameOverlay = document.getElementById('frameOverlay');

    let stage = 0, facing = 'user', stream = null, track = null;

    // === FRAME ===
    if (topic?.framePath) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = topic.framePath + '?v=' + Date.now();
        img.onload = () => {
            frameOverlay.src = img.src;
            frameOverlay.classList.add('loaded');
        };
    }

    // === CẬP NHẬT HIỂN THỊ ===
    const updateDisplay = () => {
        video1.style.display = 'none';
        video2.style.display = 'none';
        canvas.style.opacity = '0';

        if (stage === 0) {
            video1.style.display = 'block';
            updateStatus('Chụp ảnh 1');
        } else if (stage === 1) {
            canvas.style.opacity = '1';
            video2.style.display = 'block';
            updateStatus('Chụp ảnh 2');
        } else if (stage === 2) {
            canvas.style.opacity = '1';
            updateStatus('Đang xử lý...');
        }
    };

    // === KHỞI ĐỘNG CAMERA ===
    const startCamera = async (targetVideo) => {
        if (stream) stream.getTracks().forEach(t => t.stop());

        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing, width: { ideal: 1920 }, height: { ideal: 1080 } },
            audio: false
        });
        track = stream.getVideoTracks()[0];
        targetVideo.srcObject = stream;
        targetVideo.onloadedmetadata = () => {
            targetVideo.play();
            targetVideo.style.transform = facing === 'user' ? 'scaleX(-1)' : 'scaleX(1)';
        };
    };

    // === ĐẾM NGƯỢC ===
    const doCountdown = (callback) => {
        let count = 3;
        countdown.textContent = count;
        countdown.style.display = 'flex';
        const timer = setInterval(() => {
            count--;
            if (count > 0) countdown.textContent = count;
            else {
                clearInterval(timer);
                countdown.style.display = 'none';
                callback();
            }
        }, 1000);
    };

    // === CHỤP ẢNH ===
    const capture = () => {
        const video = stage === 0 ? video1 : video2;
        const vW = video.videoWidth, vH = video.videoHeight;
        if (vW === 0 || vH === 0) return;

        const yOffset = stage === 0 ? 0 : HALF;
        const targetAspect = W / HALF, vAspect = vW / vH;

        let sx, sy, sw, sh;
        if (vAspect > targetAspect) {
            sh = vH; sw = vH * targetAspect; sx = (vW - sw) / 2; sy = 0;
        } else {
            sw = vW; sh = vW / targetAspect; sx = 0; sy = (vH - sh) / 2;
        }

        ctx.save();
        if (facing === 'user') { ctx.translate(W, 0); ctx.scale(-1, 1); }
        ctx.drawImage(video, sx, sy, sw, sh, 0, yOffset, W, HALF);
        ctx.restore();

        stage++;
        updateDisplay();

        if (stage === 1) {
            startCamera(video2);
            captureBtn.disabled = false;
        } else if (stage === 2) {
            finalize();
        }
    };

    const updateStatus = (msg, type = '') => {
        status.textContent = msg;
        status.className = `status ${type}`;
    };

    // === UPLOAD ===
    const dataURLtoBlob = dataURL => {
        const [meta, b64] = dataURL.split(',');
        const mime = meta.match(/:(.*?);/)[1];
        const bin = atob(b64); let n = bin.length;
        const u8 = new Uint8Array(n);
        while (n--) u8[n] = bin.charCodeAt(n);
        return new Blob([u8], { type: mime });
    };

    const compressImage = (file, quality = 0.7, maxWidth = 800) => {
        return new Promise(resolve => {
            const img = new Image();
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let { width, height } = img;
                if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
            };
            reader.readAsDataURL(file);
        });
    };

    const uploadImgBB = async blob => {
        const form = new FormData(); form.append('image', blob);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, { method: 'POST', body: form });
        const data = await res.json();
        if (!data.success) throw new Error('Upload thất bại');
        const imageUrl = data.data.url;

        const thumbBlob = await compressImage(blob, 0.85, 500);
        const thumbForm = new FormData(); thumbForm.append('image', thumbBlob);
        const thumbRes = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, { method: 'POST', body: thumbForm });
        const thumbData = await thumbRes.json();
        const thumbUrl = thumbData.success ? thumbData.data.url : imageUrl.replace('.jpg', '-thumb.jpg');
        return { imageUrl, thumbUrl };
    };

    const saveSheet = async ({ imageUrl, thumbUrl }) => {
        const res = await fetch(CONFIG.SHEET_API_URL, { method: 'POST', body: JSON.stringify({ topic: topicId, imageUrl, thumbUrl }) });
        const data = await res.json();
        if (!data.success) throw new Error('Lưu thất bại');
    };

    const finalize = async () => {
        if (topic?.framePath) {
            const frame = new Image();
            frame.crossOrigin = 'anonymous';
            frame.src = topic.framePath;
            await new Promise(r => { frame.onload = () => { ctx.drawImage(frame, 0, 0, W, H); r(); }; });
        }

        try {
            updateStatus('Đang tải lên...', 'loading');
            const blob = dataURLtoBlob(canvas.toDataURL('image/jpeg', 0.9));
            const compressed = await compressImage(blob, 0.7, 800);
            const { imageUrl, thumbUrl } = await uploadImgBB(compressed);
            await saveSheet({ imageUrl, thumbUrl });
            updateStatus('Thành công!', 'success');
            setTimeout(() => location.href = `gallery.html?topic=${topicId}`, 2000);
        } catch (err) {
            updateStatus('Lỗi: ' + err.message, 'error');
            captureBtn.disabled = false;
        }
    };

    // === SỰ KIỆN ===
    captureBtn.onclick = () => {
        if (stage > 1) return;
        captureBtn.disabled = true;
        doCountdown(capture);
    };

    flipBtn.onclick = () => {
        facing = facing === 'user' ? 'environment' : 'user';
        const target = stage === 0 ? video1 : video2;
        startCamera(target);
    };

    // === KHỞI ĐỘNG ===
    startCamera(video1);
    updateDisplay();
</script>
</body>

</html>